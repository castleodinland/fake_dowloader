<!DOCTYPE html>
<html>
<head>
    <title>Fake Downloader For PT</title>
    <script>
        let intervalId;

        function toggleButtons(startEnabled) {
            document.getElementById("startButton").disabled = !startEnabled;
            document.getElementById("stopButton").disabled = startEnabled;
        }

        function start() {
            var peerAddr = document.getElementById("peerAddr").value;
            var infoHash = document.getElementById("infoHash").value;

            fetch('/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'peerAddr=' + encodeURIComponent(peerAddr) + '&infoHash=' + encodeURIComponent(infoHash)
            }).then(response => response.text())
              .then(data => {
                  console.log(data);
                  toggleButtons(false);
                  startMonitoring();
                  // 保存状态到本地存储
                  localStorage.setItem('isStarted', 'true');
                  localStorage.setItem('peerAddr', peerAddr);
                  localStorage.setItem('infoHash', infoHash);
              });
        }

        function stop() {
            fetch('/stop', {
                method: 'POST'
            }).then(response => response.text())
              .then(data => {
                  console.log(data);
                  toggleButtons(true);
                  stopMonitoring();
                  // 保存状态到本地存储
                  localStorage.setItem('isStarted', 'false');
              });
        }

        function startMonitoring() {
            intervalId = setInterval(fetchSpeed, 1000);
        }

        function stopMonitoring() {
            clearInterval(intervalId);
            document.getElementById("speedDisplay").innerText = "Speed: 0 MB/s";
            localStorage.setItem('speedDisplay', "Speed: 0 MB/s");
        }

        function fetchSpeed() {
            fetch('/speed')
                .then(response => response.json())
                .then(data => {
                    // 将 data.speed 除以 1024，并保留两位小数
                    const speedInMBps = (data.speed / 1024).toFixed(2);
                    const speedText = "Speed: " + speedInMBps + " MB/s";
                    document.getElementById("speedDisplay").innerText = speedText;
                    localStorage.setItem('speedDisplay', speedText);
                });
        }

        window.onload = function() {
            const isStarted = localStorage.getItem('isStarted') === 'true';
            toggleButtons(!isStarted);

            // 恢复输入框值
            if (isStarted) {
                document.getElementById("peerAddr").value = localStorage.getItem('peerAddr') || '';
                document.getElementById("infoHash").value = localStorage.getItem('infoHash') || '';
                startMonitoring();
            } else {
                stopMonitoring();
            }

            // 恢复速度显示
            const savedSpeed = localStorage.getItem('speedDisplay') || "Speed: 0 MB/s";
            document.getElementById("speedDisplay").innerText = savedSpeed;
        }
    </script>
</head>
<body>
    <h1>Fake Downloader For PT</h1>
    <input type="text" id="peerAddr" placeholder="Peer Address">
    <input type="text" id="infoHash" placeholder="Info Hash">
    <br><br>
    <button id="startButton" onclick="start()">Start</button>
    <button id="stopButton" onclick="stop()">Stop</button>
    <br><br>
    <div id="speedDisplay">Speed: 0 MB/s</div>
</body>
</html>
