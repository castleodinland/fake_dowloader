<!DOCTYPE html>
<html>
<head>
    <title>Fake Downloader For PT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #infoHash {
            width: 300px;
        }
        /* 设置图表容器的高度为页面高度的特定百分比 */
        #chartContainer {
            width: 100%;
            height: 50vh; /* 视口高度的50% */
        }
        /* 为按钮添加样式 */
        button {
            margin-right: 1em; /* 添加右边距 */
        }
    </style>
    <script>
        let intervalId;
        let speedData = [];
        let chart;

        function toggleButtons(startEnabled) {
            document.getElementById("startButton").disabled = !startEnabled;
            document.getElementById("stopButton").disabled = startEnabled;
        }

        function start() {
            var peerAddr = document.getElementById("peerAddr").value;
            var infoHash = document.getElementById("infoHash").value;

            fetch('/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'peerAddr=' + encodeURIComponent(peerAddr) + '&infoHash=' + encodeURIComponent(infoHash)
            }).then(response => response.text())
              .then(data => {
                  console.log(data);
                  toggleButtons(false);
                  startMonitoring();
                  // 保存状态到本地存储
                  localStorage.setItem('isStarted', 'true');
                  localStorage.setItem('peerAddr', peerAddr);
                  localStorage.setItem('infoHash', infoHash);
              });
        }

        function stop() {
            fetch('/stop', {
                method: 'POST'
            }).then(response => response.text())
              .then(data => {
                  console.log(data);
                  toggleButtons(true);
                  stopMonitoring();
                  // 保存状态到本地存储
                  localStorage.setItem('isStarted', 'false');

                  // 清空统计数据
                  speedData = [];
                  chart.data.labels = [];
                  chart.data.datasets[0].data = speedData;
                  chart.update();
              });
        }

        function reannounce() {
            // 禁用按钮
            var button = document.getElementById("reannounceButton");
            button.disabled = true;

            fetch('/reannounce', {
                method: 'POST'
            }).then(response => response.text())
              .then(data => {
                  console.log(data);
                  // 在这里可以显示一些提示信息给用户，比如 alert 或者更新某个 DOM 元素
                  alert("Re-announce completed");
              })
              .catch(error => {
                  console.error('Error:', error);
              })
              .finally(() => {
                  // 请求完成后启用按钮
                  button.disabled = false;
              });
        }

        function startMonitoring() {
            intervalId = setInterval(fetchSpeed, 1000);
        }

        function stopMonitoring() {
            clearInterval(intervalId);
            localStorage.setItem('speedDisplay', "Speed: 0 MB/s");
        }

        function fetchSpeed() {
            fetch('/speed')
                .then(response => response.json())
                .then(data => {
                    // 将 data.speed 除以 1024，并保留两位小数
                    const speedInMBps = (data.speed / 1024).toFixed(2);
                    const speedText = "Speed: " + speedInMBps + " MB/s";
                    document.getElementById("speedDisplay").innerText = speedText;
                    localStorage.setItem('speedDisplay', speedText);

                    // 更新图表数据
                    updateChart(speedInMBps);
                });
        }

        function updateChart(speed) {
            speedData.push(speed);
            chart.data.labels.push(''); // 添加空标签
            chart.update();
        }

        function resizeChart() {
            const chartContainer = document.getElementById('chartContainer');
            if (chart) {
                chart.resize();
            }
        }

        window.onload = function() {
            const isStarted = localStorage.getItem('isStarted') === 'true';
            toggleButtons(!isStarted);

            // 恢复输入框值
            if (isStarted) {
                document.getElementById("peerAddr").value = localStorage.getItem('peerAddr') || '';
                document.getElementById("infoHash").value = localStorage.getItem('infoHash') || '';
                startMonitoring();
            } else {
                stopMonitoring();
            }

            // 恢复速度显示
            const savedSpeed = localStorage.getItem('speedDisplay') || "Speed: 0 MB/s";
            document.getElementById("speedDisplay").innerText = savedSpeed;

            // 初始化图表
            const ctx = document.getElementById('myChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // 初始空标签
                    datasets: [{
                        label: 'Download Speed (MB/s)',
                        data: speedData,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // 不保持纵横比
                    scales: {
                        x: {
                            display: true // 显示X轴标签
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 窗口大小变化时调整图表大小
            window.addEventListener('resize', resizeChart);
        }
    </script>
</head>
<body>
    <h1>Fake Downloader For PT</h1>
    <input type="text" id="peerAddr" placeholder="Peer Address">
    <input type="text" id="infoHash" placeholder="Info Hash">
    <br><br>
    <button id="startButton" onclick="start()">Start</button>
    <button id="stopButton" onclick="stop()">Stop</button>
    <button id="reannounceButton" onclick="reannounce()" style="margin-left: 2em;">Re-announce</button>
    <br><br>
    <div id="speedDisplay">Speed: 0 MB/s</div>
    <div id="chartContainer">
        <canvas id="myChart"></canvas>
    </div>
</body>
</html>
